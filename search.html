<!DOCTYPE html>
<html>
<head>
<title>Veebilaulik</title>
<link rel="icon" type="image/x-icon" href="favicon.webp">
<link rel="stylesheet" href="style.css">
<script src="tools.js"></script>
<script src="lib/papaparse.min.js"></script>
<meta charset="UTF-8">
</head>
<body>


<div class="header">
  <a href="index.html" class="logo">Veebilaulik</a>
  <form id="topbarSearch" action="search.html" method="get">
  		<div class="embed-submit-field">
  			<input id="topbarOtsimisVali" type="text" id="searchTerm" name="searchTerm" placeholder="Otsi laulu pealkirja, autorit, numbrit">
  			<button id="topbarOtsimisKinnitus" type="submit" value="Submit">Otsi</button>
  		</div>
  </form>
</div>


<div id="otsinguContainer">
	<h1 style="text-align: left;">Otsingu tulemus:</h1>

	<div class="otsinguNupud">
		<button class="otsinguNupp" onclick='prevNr()'><</button>
		<input  class="otsinguNupp otsinguLahter" style="cursor:text" type="text" value="2" onkeypress="muudaNumbrit(this.value)" onchange="vahetaLk(this.value)"></input>
		<a class="otsinguNupp" style="cursor: text;"><!--/24--></a>
		<button class="otsinguNupp" onclick='nextNr()'>></button>
		<button class="otsinguNupp" onclick='lastNr()'>>></button>
	</div>

	<div id="otsinguTulemus">
		<!-- SIIA TULEVAD OTSINGU TULEMUSED -->
		<!--<div class="otsinguPakkumine">
			<h2 class="otsitavaPealkiri">Kiida / Praise - Hillsong</h2><a class="otsitavaId">#0123</a>
		</div>-->
		Laen tulemusi...
	</div>


	<div class="otsinguNupud">
		<button class="otsinguNupp" onclick='prevNr()'><</button>
		<input  class="otsinguNupp otsinguLahter" style="cursor:text" type="text" value="2" onkeypress="muudaNumbrit(this.value)" onchange="vahetaLk(this.value)"></input>
		<a class="otsinguNupp" style="cursor: text;"><!--/24--></a>
		<button class="otsinguNupp" onclick='nextNr()'>></button>
		<button class="otsinguNupp" onclick='lastNr()'>>></button>
	</div>

</div>

<!-- EMPTY SPACE FILLER -->
<div style="height:100%"></div>
<div class="footer">
  <a href="kuidas_kasutada.html" class="footerLink">Kuidas kasutada</a>
  <a href="teemad.html" class="footerLink">Temaatiline jaotus</a>
  <a href="panusta.html" class="footerLink">Panusta</a>
  <a href="meist.html" class="footerLink">Meist</a>
  <a href="kontakt.html" class="footerLink">Kontakt</a>
  <a href="tingimused.html" class="footerLink">Kasutustingimused</a>
</div>


<script>
var currentPage = 1;
if (!findGetParameter("lk")){
	changeValueByClassName("otsinguLahter", "value", "1")
} else {
	changeValueByClassName("otsinguLahter", "value", findGetParameter("lk"))
	currentPage = parseInt(findGetParameter("lk"));
}

function muudaNumbrit(value){
	if (value.length > 1){
		changeValueByClassName("otsinguLahter", "value", value.slice(0,1))
	}
}
var lkTulemusteArv = 10;
function vahetaLk(value){
	if (value < 1 || isNaN(value)){
		if (!findGetParameter("lk")){
			changeValueByClassName("otsinguLahter", "value", "1")
		} else {
			changeValueByClassName("otsinguLahter", "value", findGetParameter("lk"))
		}
		return
	}
	var newAdditionalURL = "";
    var tempArray = window.location.href.split("?");
    var baseURL = tempArray[0];
    var additionalURL = tempArray[1];
    var temp = "";
    if (additionalURL) {
        tempArray = additionalURL.split("&");
        for (var i=0; i<tempArray.length; i++){
            if(tempArray[i].split('=')[0] != "lk"){
                newAdditionalURL += temp + tempArray[i];
                temp = "&";
            }
        }
    }
    var rows_txt = temp + "" + "lk" + "=" + value;
    const url = baseURL + "?" + newAdditionalURL + rows_txt;
    window.open(url, "_self")
}
function nextNr(){
	vahetaLk(parseInt(document.getElementsByClassName("otsinguLahter")[0].value)+1);
}
function prevNr(){
	vahetaLk(parseInt(document.getElementsByClassName("otsinguLahter")[0].value)-1);
}
function lastNr(){
	vahetaLk(parseInt(document.getElementsByClassName("otsinguNupp")[2].innerText.substring(1)));
}

document.getElementById("topbarOtsimisVali").value = decodeURIComponent(findGetParameter("searchTerm").replace(/\+/g, '%20')).trim();


/*OTSIMINE TOIMUB SIIN*/
getSongIndex().then(songIndex => {
	var results = [];
	const toSearch = decodeURIComponent(findGetParameter("searchTerm").toLowerCase().replace(/\+/g, '%20')).trim();
	for(var i=0; i<songIndex.length; i++) {
	  for(key in songIndex[i]) {
	    if(songIndex[i][key].toLowerCase().indexOf(toSearch)!=-1) {
	    	if (results.some(e => e.fail === songIndex[i].fail)){} else {
	    		results.push(songIndex[i]);
	    	}
	    }
	  }
	}

	if(results.length > 0){
		document.getElementById("otsinguTulemus").innerHTML = "";
	} else {
		document.getElementById("otsinguTulemus").innerHTML = "Ei õnnestunud ühtegi vastet leida.";
	}
	
	var lkArv = "/1";
	if (results.length > 0){
		lkArv = "/" + findNextMultiplier(results.length, lkTulemusteArv)/lkTulemusteArv;
	}
	document.getElementsByClassName("otsinguNupp")[2].innerText = lkArv;
	document.getElementsByClassName("otsinguNupp")[7].innerText = lkArv;

	if (results.length > (currentPage-1) * lkTulemusteArv){
		algus = (currentPage-1) * lkTulemusteArv;

		if(algus+lkTulemusteArv > results.length){
			for (let i=algus; i<results.length; i++){
				looOtsitavaPakkumine(i, results);
			}
		} else {
			for (let i=algus; i<(lkTulemusteArv+algus); i++){
				looOtsitavaPakkumine(i, results);
			}
		}
	}
	
	
	
})

function looOtsitavaPakkumine(looNumber, songIndex){
	var container = document.createElement("div");
	container.classList.add("otsinguPakkumine");
	container.onclick = function(){window.open("laulud/" + songIndex[looNumber].fail + ".html", "_self")};
	var pealkiri = ""
	if (songIndex[looNumber].orgpealkiri){
		pealkiri = songIndex[looNumber].pealkiri + " / " + songIndex[looNumber].orgpealkiri + " - " + songIndex[looNumber].viisi_autor
	} else {
		pealkiri = songIndex[looNumber].pealkiri + " - " + songIndex[looNumber].viisi_autor
	}
	container.innerHTML = '<h2 class="otsitavaPealkiri">' + pealkiri +'</h2><a class="otsitavaId">'+ songIndex[looNumber].id +'</a>'
	document.getElementById("otsinguTulemus").appendChild(container);
}

</script>




</body>
</html>